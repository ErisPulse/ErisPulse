name: ğŸ€ è‰¾è‰ä¸çš„æ¨¡å—ä»“åº“æ›´æ–°é­”æ³• ~

# å½“æœ‰æ–°çš„æ¨¡å—/é€‚é…å™¨/CLIæ‰©å±•æäº¤æ—¶è‡ªåŠ¨æ›´æ–°ä»“åº“
on:
  issues:
    types: [opened, edited, labeled]
    
# æ·»åŠ è°ƒè¯•æ—¥å¿—
env:
  DEBUG: true

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-and-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ€ è°ƒè¯• - æ‰“å°å·¥ä½œæµä¸Šä¸‹æ–‡
        run: |
          echo "===== å·¥ä½œæµè°ƒè¯•ä¿¡æ¯ ====="
          echo "äº‹ä»¶ç±»å‹: ${{ github.event.action }}"
          echo "Issue ç¼–å·: ${{ github.event.issue.number }}"
          echo "Issue æ ‡é¢˜: ${{ github.event.issue.title }}"
          echo "Issue æ ‡ç­¾: ${{ toJson(github.event.issue.labels) }}"
          echo "æ¡ä»¶åˆ¤æ–­ç»“æœ: ${{ contains(github.event.issue.labels.*.name, 'module-submit') || contains(github.event.issue.labels.*.name, 'adapter-submit') || contains(github.event.issue.labels.*.name, 'cli-submit') }}"
          echo "========================="
          
      # åªå¤„ç†å¸¦æœ‰ç‰¹å®šæ ‡ç­¾çš„issue
      - name: ğŸ€ æ£€æŸ¥æ ‡ç­¾
        if: |
          contains(github.event.issue.labels.*.name, 'module-submit') ||
          contains(github.event.issue.labels.*.name, 'adapter-submit') ||
          contains(github.event.issue.labels.*.name, 'cli-submit')

    steps:
      - name: æ£€å‡ºé­”æ³•ä¹¦
        uses: actions/checkout@v4
        with:
          repository: ErisPulse/ErisPulse-ModuleRepo
          token: ${{ secrets.MODULE_REPO_TOKEN }}
          path: module-repo

      - name: è§£ææäº¤å†…å®¹
        id: parse_issue
        run: |
          echo "âœ¨ æ­£åœ¨è§£æé­”æ³•å·è½´..."
          BODY="${{ github.event.issue.body }}"
          
          # æå–åŸºæœ¬ä¿¡æ¯
          NAME=$(echo "$BODY" | grep -oP 'åç§°[:ï¼š]\s*\K.*')
          VERSION=$(echo "$BODY" | grep -oP 'ç‰ˆæœ¬[:ï¼š]\s*\K.*')
          AUTHOR=$(echo "$BODY" | grep -oP 'ä½œè€…[:ï¼š]\s*\K.*')
          DESC=$(echo "$BODY" | grep -oP 'æè¿°[:ï¼š]\s*\K.*')
          REPO=$(echo "$BODY" | grep -oP 'ä»“åº“[:ï¼š]\s*\K.*')
          PYPI=$(echo "$BODY" | grep -oP 'PyPIåŒ…å[:ï¼š]\s*\K.*')
          TYPE=$(echo "$BODY" | grep -oP 'ç±»å‹[:ï¼š]\s*\K.*')

          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "desc=$DESC" >> $GITHUB_OUTPUT
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "pypi=$PYPI" >> $GITHUB_OUTPUT
          echo "type=$TYPE" >> $GITHUB_OUTPUT

          if [ -z "$NAME" ] || [ -z "$VERSION" ] || [ -z "$AUTHOR" ] || [ -z "$DESC" ] || [ -z "$REPO" ] || [ -z "$PYPI" ] || [ -z "$TYPE" ]; then
            echo "ğŸ’¢ é­”æ³•å·è½´ä¸å®Œæ•´!"
            exit 1
          fi

      - name: æ›´æ–°é­”æ³•ä¹¦
        run: |
          cd module-repo
          echo "ğŸ“– æ­£åœ¨æ›´æ–°é­”æ³•ä¹¦..."

          # æ ¹æ®ç±»å‹æ›´æ–°ä¸åŒçš„éƒ¨åˆ†
          if [ "${{ steps.parse_issue.outputs.type }}" == "æ¨¡å—" ]; then
            jq --arg name "${{ steps.parse_issue.outputs.name }}" \
               --argjson entry "$(jq -n \
                 --arg pkg "ErisPulse-${{ steps.parse_issue.outputs.name }}" \
                 --arg ver "${{ steps.parse_issue.outputs.version }}" \
                 --arg author "${{ steps.parse_issue.outputs.author }}" \
                 --arg desc "${{ steps.parse_issue.outputs.desc }}" \
                 --arg repo "${{ steps.parse_issue.outputs.repo }}" \
                 --arg pypi "${{ steps.parse_issue.outputs.pypi }}" \
                 '{package: $pkg, version: $ver, author: $author, description: $desc, repository: $repo, pypi_package: $pypi, min_sdk_version: "2.0.0", official: false}')" \
               '.modules[$name] = $entry' packages.json > temp.json
          elif [ "${{ steps.parse_issue.outputs.type }}" == "é€‚é…å™¨" ]; then
            jq --arg name "${{ steps.parse_issue.outputs.name }}" \
               --argjson entry "$(jq -n \
                 --arg pkg "ErisPulse-${{ steps.parse_issue.outputs.name }}Adapter" \
                 --arg ver "${{ steps.parse_issue.outputs.version }}" \
                 --arg desc "${{ steps.parse_issue.outputs.desc }}" \
                 --arg repo "${{ steps.parse_issue.outputs.repo }}" \
                 --arg pypi "${{ steps.parse_issue.outputs.pypi }}" \
                 '{package: $pkg, version: $ver, description: $desc, repository: $repo, pypi_package: $pypi, official: false}')" \
               '.adapters[$name] = $entry' packages.json > temp.json
          else
            jq --arg name "${{ steps.parse_issue.outputs.name }}" \
               --argjson entry "$(jq -n \
                 --arg pkg "ErisPulse-${{ steps.parse_issue.outputs.name }}" \
                 --arg ver "${{ steps.parse_issue.outputs.version }}" \
                 --arg author "${{ steps.parse_issue.outputs.author }}" \
                 --arg desc "${{ steps.parse_issue.outputs.desc }}" \
                 --arg repo "${{ steps.parse_issue.outputs.repo }}" \
                 --arg pypi "${{ steps.parse_issue.outputs.pypi }}" \
                 '{package: $pkg, version: $ver, author: $author, description: $desc, repository: $repo, pypi_package: $pypi, min_sdk_version: "2.0.0", official: false}')" \
               '.cli[$name] = $entry' packages.json > temp.json
          fi

          mv temp.json packages.json

      - name: æäº¤é­”æ³•æ›´æ–°
        run: |
          cd module-repo
          git config --global user.name "ErisPulse Bot"
          git config --global user.email "bot@erispulse.github"
          
          git add packages.json
          git commit -m "âœ¨ [Bot] æ›´æ–°${{ steps.parse_issue.outputs.type }}: ${{ steps.parse_issue.outputs.name }}"
          git push

      - name: å…³é—­é­”æ³•å·è½´
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            })