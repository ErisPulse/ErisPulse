name: ğŸ€ è‰¾è‰ä¸çš„ç‰ˆæœ¬ä¸å‘å¸ƒç®¡ç† ~

on:
  push:
    branches: [main]
    tags:
      - "v*.*.*"      # v2.0.0
      - "v*.*.*.dev*" # v2.0.0.dev0

  workflow_dispatch: {} # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  version-management:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è¯»å–é­”æ³•å·è½´
        id: info
        shell: bash
        run: |
          # è§£è¯»ç‰ˆæœ¬é­”æ³•
          version=$(grep '^version' pyproject.toml | head -1 | sed 's/version = "//;s/"//')
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "âœ¨ å‘ç°æ–°ç‰ˆæœ¬: $version"

          # æ£€æŸ¥æ˜¯å¦æ˜¯è¯•éªŒé­”æ³•
          if [[ $version =~ dev|alpha|beta|a|b ]]; then
            echo "is_dev=true" >> $GITHUB_OUTPUT
          else
            echo "is_dev=false" >> $GITHUB_OUTPUT
          fi

          # è·å–é­”æ³•å˜æ›´è®°å½•
          commit_msg=$(git log -1 --pretty=%B)
          commit_short=$(git rev-parse --short HEAD)
          echo "commit_short=$commit_short" >> $GITHUB_OUTPUT
          echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "$commit_msg" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨
        id: changed_files
        shell: bash
        run: |
          before="${{ github.event.before }}"
          after="${{ github.sha }}"

          if [[ "$before" == "0000000000000000000000000000000000000000" ]]; then
            before="HEAD~1"
          fi

          echo "before=$before" >> $GITHUB_OUTPUT
          echo "after=$after" >> $GITHUB_OUTPUT

          # è·å–ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆæœ€å¤šæ˜¾ç¤º20ä¸ªï¼‰
          files=$(git diff --name-only $before..$after | head -n 20 | xargs)
          file_count=$(git diff --name-only $before..$after | wc -l)

          if [ "$file_count" -gt 20 ]; then
            files="$files ..."
          fi

          echo "files=$files" >> $GITHUB_OUTPUT

      - name: æ–½å±•ç‰ˆæœ¬é­”æ³•
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          version="${{ steps.info.outputs.version }}"
          commit_short="${{ steps.info.outputs.commit_short }}"
          commit_msg="${{ steps.info.outputs.commit_msg }}"
          is_dev="${{ steps.info.outputs.is_dev }}"
          tag_name="v$version"

          # è¯»å–é­”æ³•è®°å½•ä¹¦
          if [ -f "docs/CHANGELOG.md" ]; then
            changelog=$(sed -n "/^## \[$version\]/,/^## /p" docs/CHANGELOG.md | sed '1d;$d')
          fi

          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°è®°å½•,å°±ç”¨ç®€å•çš„é­”æ³•
          if [ -z "$changelog" ]; then
            changelog="### âœ¨ é­”æ³•æ›´æ–°\n\n- $commit_msg ($commit_short)"
          fi

          # æ£€æŸ¥é­”æ³•å°è®°æ˜¯å¦å·²å­˜åœ¨
          if ! git rev-parse "$tag_name" >/dev/null 2>&1; then
            echo "ğŸ€ æ–½åŠ æ–°çš„é­”æ³•å°è®°..."
            git tag "$tag_name"
            git push origin "$tag_name"
          fi

          # åœ¨é­”æ³•é›†å¸‚ä¸Šå‘å¸ƒ
          if gh release view "$tag_name" &>/dev/null; then
            # æ›´æ–°å·²æœ‰çš„é­”æ³•
            gh release edit "$tag_name" \
              --notes "$changelog" \
              --prerelease=$is_dev
            echo "ğŸŒŸ å·²æ›´æ–°é­”æ³•ç‰ˆæœ¬ $tag_name"
          else
            # å‘å¸ƒæ–°çš„é­”æ³•
            gh release create "$tag_name" \
              --notes "$changelog" \
              --title "âœ¨ è‰¾è‰ä¸çš„é­”æ³•æ›´æ–° $tag_name" \
              --prerelease=$is_dev
            echo "âœ¨ å·²å‘å¸ƒæ–°çš„é­”æ³•ç‰ˆæœ¬ $tag_name"
          fi

      - name: è¯»å–æ”¶ä»¶äººåˆ—è¡¨
        id: get_emails
        run: |
          emails=$(cat .github/config/notify.json | jq -c '.emails')
          echo "emails=$emails" >> $GITHUB_OUTPUT

      - name: å‘é€é‚®ä»¶é€šçŸ¥
        uses: ./.github/workflows/send-email
        with:
          subject: "[è‰¾è‰ä¸å¿«æŠ¥] ä¸»åˆ†æ”¯è«åå…¶å¦™å¤šå‡ºæ¥ä¸€äº›ä¸çŸ¥é“çš„ä¸œè¥¿..."
          content: |
            <div style="font-family: 'Segoe UI', sans-serif; background-color: #1e1e2f; color: #ffffff; padding: 20px; border-radius: 8px;">
              <table width="100%" cellpadding="0" cellspacing="0">
                <tr>
                  <td align="center">
                    <img src="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/assets/erispulse_logo.png" alt="ErisPulse Logo"/>
                  </td>
                </tr>
              </table>

              <h2 style="color: #ff6ec7;">å–‚ï¼ä¸»åˆ†æ”¯åˆè¢«äººåŠ¨è¿‡äº†å§ï¼Ÿ</h2>

              <hr style="border: none; border-top: 1px solid #333; margin: 20px 0;" />

              <p><strong>æäº¤è€…ï¼š</strong> ${{ github.event.pusher.name }}</p>
              <p><strong>æäº¤ä¿¡æ¯ï¼š</strong></p>
              <pre style="background-color: #2d2d3d; padding: 10px; border-radius: 4px; white-space: pre-wrap;">${{ steps.info.outputs.commit_msg }}</pre>

              <p><strong>ä¿®æ”¹çš„æ–‡ä»¶ï¼š</strong><br/>
              <code style="background-color: #2d2d3d; padding: 4px 8px; border-radius: 4px;">${{ steps.changed_files.outputs.files }}</code></p>

              <p><strong>å˜æ›´åœ°å€ï¼š</strong><br/>
              <a href="https://github.com/${{ github.repository }}/compare/${{ steps.changed_files.outputs.before }}...${{ steps.changed_files.outputs.after }}?expand=1" style="color: #7acbf7; text-decoration: none;">
                æŸ¥çœ‹å˜æ›´
              </a></p>

              <p>â€”â€” è‰¾è‰ä¸Â·æ ¼é›·æ‹‰ç‰¹ âš”ï¸</p>
            </div>
          recipients: ${{ steps.get_emails.outputs.emails }}
          resend_api_key: ${{ secrets.RESEND_API_KEY }}
          feishu_smtp_password: ${{ secrets.FEISHU_SMTP_PASSWORD }}

  build-and-publish:
    needs: version-management
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      id-token: write

    environment:
      name: pypi
      url: https://pypi.org/p/erispulse

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ç‰ˆæœ¬æ£€æŸ¥
        id: version
        run: |
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          echo "âœ¨ å½“å‰ç‰ˆæœ¬: $CURRENT_TAG"

          if [[ $CURRENT_TAG =~ \.dev|\.alpha|\.beta ]]; then
            BASE_VERSION=$(echo $CURRENT_TAG | sed -E 's/([0-9]+)$//')
            PREV_TAG=$(git tag --sort=-v:refname | grep "^$BASE_VERSION" | grep -v "$CURRENT_TAG" | head -n 1)

            if [ -z "$PREV_TAG" ]; then
              echo "ğŸ’¢ æ‰¾ä¸åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬!"
              exit 1
            fi
            echo "ğŸ€ å‘ç°ä¸Šä¸€ä¸ªè¯•éªŒç‰ˆæœ¬: $PREV_TAG"
            git checkout $PREV_TAG
            echo "use_current=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸŒŸ æ­£å¼ç‰ˆæœ¬~"
            echo "use_current=true" >> $GITHUB_OUTPUT
          fi

      - name: ç¯å¢ƒå‡†å¤‡
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: æ‰“åŒ…æ„å»º
        run: |
          python -m pip install --upgrade pip
          python -m pip install build
          python -m build

      - name: æš‚å­˜åŒ…è£¹
        uses: actions/upload-artifact@v4
        with:
          name: release-dists
          path: dist/

      - name: è·å–åŒ…è£¹
        uses: actions/download-artifact@v4
        with:
          name: release-dists
          path: dist/

      - name: å‘å¸ƒä¸Šä¼ 
        id: publish
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          verbose: true

      - name: è¯»å–æ”¶ä»¶äººåˆ—è¡¨
        id: get_emails
        run: |
          emails=$(cat .github/config/notify.json | jq -c '.emails')
          echo "emails=$emails" >> $GITHUB_OUTPUT

      - name: å‘é€é‚®ä»¶é€šçŸ¥
        uses: ./.github/workflows/send-email
        with:
          subject: "[è‰¾è‰ä¸å¿«æŠ¥] æ–°ç‰ˆæœ¬ ${{ steps.version.outputs.CURRENT_TAG }} å·²å‘å¸ƒè‡³ PyPIï¼âœ¨"
          content: |
            <div style="font-family: 'Segoe UI', sans-serif; background-color: #1e1e2f; color: #ffffff; padding: 20px; border-radius: 8px;">
              <table width="100%" cellpadding="0" cellspacing="0">
                <tr>
                  <td align="center">
                    <img src="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/assets/erispulse_logo.png" alt="ErisPulse Logo"/>
                  </td>
                </tr>
              </table>

              <h2 style="color: #ff6ec7;">ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒå•¦ï¼</h2>

              <hr style="border: none; border-top: 1px solid #333; margin: 20px 0;" />

              <p><strong>ç‰ˆæœ¬å·ï¼š</strong> ${{ steps.version.outputs.CURRENT_TAG }}</p>
              <p><strong>åŒ…åœ°å€ï¼š</strong> 
              <a href="https://pypi.org/project/erispulse/${{ steps.version.outputs.CURRENT_TAG }}" style="color: #7acbf7; text-decoration: none;">
                ç‚¹å‡»æŸ¥çœ‹
              </a></p>

              <p><strong>æ›´æ–°å†…å®¹ï¼š</strong></p>
              <pre style="background-color: #2d2d3d; padding: 10px; border-radius: 4px; white-space: pre-wrap;">${{ steps.version.outputs.CURRENT_TAG }}</pre>

              <p>â€”â€” è‰¾è‰ä¸Â·æ ¼é›·æ‹‰ç‰¹ âš”ï¸</p>
            </div>
          recipients: ${{ steps.get_emails.outputs.emails }}
          resend_api_key: ${{ secrets.RESEND_API_KEY }}
          feishu_smtp_password: ${{ secrets.FEISHU_SMTP_PASSWORD }}