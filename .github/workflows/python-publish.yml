name: Upload Python Package

on:
  push:
    tags:
      - 'v*.*.*'          # 正式版本
      - 'v*.*.*dev*'      # 开发版本
      - 'v*.*.*alpha*'    # alpha版本
      - 'v*.*.*beta*'     # beta版本
      - 'v*.*.*a*'        # alpha简写
      - 'v*.*.*b*'        # beta简写
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  release-build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 检查并切换版本
        id: version
        run: |
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          # 如果是开发版本，直接使用当前版本
          if [[ $CURRENT_TAG =~ dev|alpha|beta|a|b ]]; then
            echo "使用当前开发版本: $CURRENT_TAG"
            echo "use_current=true" >> $GITHUB_OUTPUT
          else
            # 如果是正式版本，使用上一个版本
            PREV_TAG=$(git tag --sort=-v:refname | grep -v "$CURRENT_TAG" | grep "^v" | head -n 1)
            if [ -z "$PREV_TAG" ]; then
              echo "错误：没有找到上一个版本标签"
              exit 1
            fi
            echo "使用上一个版本: $PREV_TAG"
            git checkout $PREV_TAG
            echo "use_current=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Build release distributions
        run: |
          python -m pip install --upgrade pip
          python -m pip install build
          python -m build

      - name: Upload distributions
        uses: actions/upload-artifact@v4
        with:
          name: release-dists
          path: dist/

  pypi-publish:
    runs-on: ubuntu-latest
    needs:
      - release-build
    permissions:
      id-token: write

    environment:
      name: pypi
      url: https://pypi.org/p/erispulse

    steps:
      - name: Retrieve release distributions
        uses: actions/download-artifact@v4
        with:
          name: release-dists
          path: dist/

      - name: Publish release distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          verbose: true