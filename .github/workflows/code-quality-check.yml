name: ğŸ” è‰¾è‰ä¸çš„ä»£ç å®¡æŸ¥é­”æ³• ~

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
  push:
  workflow_dispatch:

jobs:
  code-quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºé­”æ³•ä¹¦
        uses: actions/checkout@v4

      - name: ç¼“å­˜ Python ä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ruff
          key: ${{ runner.os }}-python-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-python-

      - name: å‡†å¤‡é­”æ³•ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: å®‰è£… Ruff å®¡æŸ¥ç²¾çµ
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: å°è¯•è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜
        id: ruff_fix
        continue-on-error: true
        run: |
          echo "âœ¨ è‰¾è‰ä¸æ­£åœ¨å°è¯•è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜..."
          ruff check --quiet --exit-zero --select ALL .
          ruff format --quiet .
          ruff --fix --exit-zero .

      - name: æ–½å±•ä»£ç å®¡æŸ¥é­”æ³•
        id: ruff_check
        run: |
          echo "ğŸ” è‰¾è‰ä¸æ­£åœ¨å®¡æŸ¥ä»£ç è§„èŒƒ..."
          # ä¿å­˜ Ruff è¾“å‡ºåˆ°æ–‡ä»¶å¹¶æ•è·é€€å‡ºç 
          ruff check --output-format=github . > ruff_output.txt 2>&1 || echo "RUFF_EXIT_CODE=$?" >> $GITHUB_ENV
          
      - name: å±•ç¤ºé­”æ³•ç»†èŠ‚å¹¶åœ¨ PR ä¸­è¯„è®º
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let output = 'æ²¡æœ‰å‘ç°é—®é¢˜';
            try {
              output = fs.readFileSync('ruff_output.txt', 'utf8');
            } catch (err) {
              output = 'æ— æ³•è¯»å– Ruff è¾“å‡º: ' + err.message;
            }
            
            const body = `
            ## ğŸ” Ruff ä»£ç å®¡æŸ¥æŠ¥å‘Š

            <details>
            <summary>ğŸ“ ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†é—®é¢˜ (${output.split('\n').length} ä¸ª)</summary>

            \`\`\`
            ${output}
            \`\`\`

            </details>

            ### å¦‚ä½•ä¿®å¤è¿™äº›é—®é¢˜ï¼Ÿ

            1ï¸âƒ£ **è‡ªåŠ¨ä¿®å¤** (å¯ä¿®å¤çº¦ 80% çš„é—®é¢˜):
            \`\`\`bash
            ruff check .
            ruff --fix .
            \`\`\`

            2ï¸âƒ£ **æ‰‹åŠ¨ä¿®å¤**:
            è¯·æŸ¥çœ‹ä¸Šæ–¹åˆ—å‡ºçš„å…·ä½“é—®é¢˜ï¼Œé€é¡¹ä¿®å¤

            3ï¸âƒ£ **å¿½ç•¥ç‰¹å®šè§„åˆ™** (è°¨æ…ä½¿ç”¨):
            åœ¨ pyproject.toml æˆ– ruff.toml ä¸­æ·»åŠ :
            \`\`\`toml
            [tool.ruff]
            ignore = ["E501", "F401"]
            \`\`\`
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: ä¸Šä¼ å®¡æŸ¥æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: ruff-code-review-report
          path: ruff_output.txt

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: rm -f ruff_output.txt