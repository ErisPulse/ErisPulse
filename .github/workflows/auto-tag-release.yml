name: ðŸŽ€ è‰¾èŽ‰ä¸çš„ç‰ˆæœ¬æ ‡ç­¾é­”æ³• ~

permissions:
  contents: write

on:
  push:
    branches: [main, Pre-Release/v2]

jobs:
  update-all-releases:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: æ–½å±•ç‰ˆæœ¬é­”æ³•
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          # åˆ›å»ºæ›´æ–°æ‰€æœ‰å‘è¡Œçš„è„šæœ¬
          cat > update_all_releases.py << 'EOF'
          import re
          import subprocess
          import os
          import sys

          def get_all_tags():
              """èŽ·å–æ‰€æœ‰ç‰ˆæœ¬æ ‡ç­¾"""
              try:
                  result = subprocess.run(
                      ['git', 'tag', '--sort=-version:refname'],
                      capture_output=True, text=True, check=True
                  )
                  tags = [tag.strip() for tag in result.stdout.split('\n') if tag.strip() and tag.startswith('v')]
                  return tags
              except subprocess.CalledProcessError as e:
                  print(f"èŽ·å–æ ‡ç­¾å¤±è´¥: {e}")
                  return []

          def get_changelog_for_version(version):
              """ä»ŽCHANGELOG.mdä¸­èŽ·å–æŒ‡å®šç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—"""
              changelog_path = 'CHANGELOG.md'
              
              if not os.path.exists(changelog_path):
                  return None
                  
              with open(changelog_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # ç›´æŽ¥ä½¿ç”¨ç‰ˆæœ¬å·åŒ¹é…æ ¼å¼ï¼š## [2.3.0-dev.5] - 2025/12/21
              pattern = rf'## \[{re.escape(version)}\] - .*?(?=^## |\Z)'
              match = re.search(pattern, content, re.MULTILINE | re.DOTALL)
              
              if match:
                  changelog_section = match.group(0)
                  # ç§»é™¤å¼€å¤´çš„æ ‡é¢˜è¡Œï¼ˆç¬¬ä¸€è¡Œï¼‰
                  lines = changelog_section.split('\n')
                  if lines:
                      # ç§»é™¤ç¬¬ä¸€è¡Œï¼ˆæ ‡é¢˜è¡Œï¼‰
                      changelog_lines = lines[1:]
                      # åŽ»é™¤ç©ºè¡Œ
                      changelog_content = '\n'.join(line for line in changelog_lines if line.strip())
                      return changelog_content
              
              return None

          def get_release_info(tag):
              """èŽ·å–å‘è¡Œä¿¡æ¯ï¼Œå¦‚æžœä¸å­˜åœ¨åˆ™åˆ›å»º"""
              try:
                  # å…ˆå°è¯•èŽ·å–å‘è¡Œä¿¡æ¯
                  result = subprocess.run(
                      ['gh', 'release', 'view', tag, '--json', 'prerelease'],
                      capture_output=True, text=True, check=True
                  )
                  is_prerelease = '"prerelease": true' in result.stdout
                  return is_prerelease
              except subprocess.CalledProcessError:
                  # å¦‚æžœå‘è¡Œä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
                  version = tag.replace('v', '')
                  changelog = get_changelog_for_version(version)
                  
                  if not changelog:
                      print(f"  æ— æ³•åˆ›å»ºå‘è¡Œ {tag}ï¼šæ‰¾ä¸åˆ°æ›´æ–°æ—¥å¿—")
                      return None
                  
                  # åˆ¤æ–­æ˜¯å¦ä¸ºå¼€å‘ç‰ˆæœ¬
                  is_dev = 'dev' in version or 'alpha' in version or 'beta' in version or 'pre' in version
                  is_prerelease_str = 'true' if is_dev else 'false'
                  
                  try:
                      # åˆ›å»ºå‘è¡Œ
                      subprocess.run(
                          ['gh', 'release', 'create', tag, '--notes', changelog, '--title', f'âœ¨ è‰¾èŽ‰ä¸çš„é­”æ³•æ›´æ–° {tag}', f'--prerelease={is_prerelease_str}'],
                          capture_output=True, text=True, check=True
                      )
                      print(f"  âœ… å·²åˆ›å»ºå‘è¡Œ {tag}")
                      return is_dev
                  except subprocess.CalledProcessError as e:
                      print(f"  âŒ åˆ›å»ºå‘è¡Œ {tag} å¤±è´¥: {e}")
                      return None

          def update_release(tag, changelog, is_prerelease):
              """æ›´æ–°å‘è¡Œä¿¡æ¯"""
              try:
                  # ç›´æŽ¥ä½¿ç”¨æ›´æ–°æ—¥å¿—å†…å®¹ï¼Œä¸æ·»åŠ ä»»ä½•é¢å¤–å†…å®¹
                  subprocess.run(
                      ['gh', 'release', 'edit', tag, '--notes', changelog, f'--prerelease={is_prerelease}'],
                      capture_output=True, text=True, check=True
                  )
                  print(f"  âœ… å·²æ›´æ–°å‘è¡Œ {tag}")
                  return True
              except subprocess.CalledProcessError as e:
                  print(f"  âŒ æ›´æ–°å‘è¡Œ {tag} å¤±è´¥: {e}")
                  return False

          def main():
              # èŽ·å–æ‰€æœ‰æ ‡ç­¾
              tags = get_all_tags()
              
              if not tags:
                  print("æœªæ‰¾åˆ°ä»»ä½•æ ‡ç­¾")
                  return
              
              print(f"æ‰¾åˆ° {len(tags)} ä¸ªæ ‡ç­¾ï¼Œå¼€å§‹å¤„ç†...")
              
              updated_count = 0
              skipped_count = 0
              
              for tag in tags:
                  if not tag:
                      continue
                  
                  # ä»Žæ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å·
                  version = tag.replace('v', '')
                  print(f"\nå¤„ç†æ ‡ç­¾: {tag}")
                  
                  # èŽ·å–æ›´æ–°æ—¥å¿—
                  changelog = get_changelog_for_version(version)
                  
                  if not changelog:
                      print(f"  âš ï¸ æœªæ‰¾åˆ°ç‰ˆæœ¬ {version} çš„æ›´æ–°æ—¥å¿—ï¼Œè·³è¿‡")
                      skipped_count += 1
                      continue
                  
                  # èŽ·å–å‘è¡Œä¿¡æ¯ï¼ˆå¦‚æžœä¸å­˜åœ¨åˆ™ä¼šåˆ›å»ºï¼‰
                  is_prerelease = get_release_info(tag)
                  
                  if is_prerelease is None:
                      print(f"  âš ï¸ æ— æ³•å¤„ç†å‘è¡Œ {tag}ï¼Œè·³è¿‡")
                      skipped_count += 1
                      continue
                  
                  # æ›´æ–°å‘è¡Œ
                  if update_release(tag, changelog, is_prerelease):
                      updated_count += 1
              
              print(f"\nðŸŽ‰ å®Œæˆ! æ›´æ–°äº† {updated_count} ä¸ªå‘è¡Œï¼Œè·³è¿‡äº† {skipped_count} ä¸ªå‘è¡Œã€‚")

          if __name__ == "__main__":
              main()
          EOF
          
          # æ‰§è¡Œè„šæœ¬
          python update_all_releases.py
          
          # å¤„ç†å½“å‰ç‰ˆæœ¬ï¼ˆå¦‚æžœéœ€è¦ï¼‰
          if [ -f "pyproject.toml" ]; then
            version=$(grep '^version' pyproject.toml | head -1 | sed 's/version = "//;s/"//')
            tag_name="v$version"
            
            # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
            if ! git rev-parse "$tag_name" >/dev/null 2>&1; then
              echo "ðŸŽ€ðŸŽ€ åˆ›å»ºæ–°æ ‡ç­¾ $tag_name..."
              git tag "$tag_name"
              git push origin "$tag_name"
              echo "âœ¨ å·²åˆ›å»ºæ–°æ ‡ç­¾ $tag_name"
            else
              echo "æ ‡ç­¾ $tag_name å·²å­˜åœ¨"
            fi
          fi
