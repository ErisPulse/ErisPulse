name: ğŸ€ è‰¾è‰ä¸çš„ç‰ˆæœ¬æ ‡ç­¾é­”æ³• ~

permissions:
  contents: write

on:
  push:
    branches: [main, Pre-Release/v2]

jobs:
  auto-tag-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è¯»å–ç‰ˆæœ¬å·è½´
        id: info
        shell: bash
        run: |
          version=$(grep '^version' pyproject.toml | head -1 | sed 's/version = "//;s/"//')
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "å‘ç°æ–°ç‰ˆæœ¬: $version"

          if [[ $version =~ dev|alpha|beta|a|b ]]; then
            echo "is_dev=true" >> $GITHUB_OUTPUT
          else
            echo "is_dev=false" >> $GITHUB_OUTPUT
          fi

          commit_msg=$(git log -1 --pretty=%B)
          commit_short=$(git rev-parse --short HEAD)
          commit_author=$(git log -1 --pretty=%an)
          commit_email=$(git log -1 --pretty=%ae)
          echo "commit_short=$commit_short" >> $GITHUB_OUTPUT
          echo "commit_author=$commit_author" >> $GITHUB_OUTPUT
          echo "commit_email=$commit_email" >> $GITHUB_OUTPUT
          echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "$commit_msg" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨å’Œè´¡çŒ®è€…
        id: changed_files
        shell: bash
        run: |
          before="${{ github.event.before }}"
          after="${{ github.sha }}"

          if [[ "$before" == "0000000000000000000000000000000000000000" ]]; then
            before="HEAD~1"
          fi

          echo "before=$before" >> $GITHUB_OUTPUT
          echo "after=$after" >> $GITHUB_OUTPUT

          # è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨
          files=$(git diff --name-only $before..$after | head -n 50 | xargs)
          file_count=$(git diff --name-only $before..$after | wc -l)

          if [ "$file_count" -gt 50 ]; then
            files="$files ..."
          fi
          echo "files=$files" >> $GITHUB_OUTPUT

          # è·å–è´¡çŒ®è€…åˆ—è¡¨
          contributors=$(git log $before..$after --format="%an <%ae>" | sort -u)
          echo "contributors<<EOF" >> $GITHUB_OUTPUT
          echo "$contributors" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: æ–½å±•ç‰ˆæœ¬é­”æ³•
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          version="${{ steps.info.outputs.version }}"
          commit_short="${{ steps.info.outputs.commit_short }}"
          commit_author="${{ steps.info.outputs.commit_author }}"
          commit_email="${{ steps.info.outputs.commit_email }}"
          commit_msg="${{ steps.info.outputs.commit_msg }}"
          is_dev="${{ steps.info.outputs.is_dev }}"
          contributors="${{ steps.changed_files.outputs.contributors }}"
          tag_name="v$version"
          
          # æ„å»ºå‘å¸ƒè¯´æ˜
          if [ -f "CHANGELOG.md" ]; then
            changelog_section=$(sed -n "/^## \[$version\]/,/^## /p" CHANGELOG.md | sed '1d;$d')
            
            if [ -n "$changelog_section" ]; then
              changelog_section=$(echo "$changelog_section" | sed 's/^/  /')
              changelog="## ğŸ“‹ æ›´æ–°æ—¥å¿—\n\n$changelog_section\n\n"
            fi
          fi
          
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ›´æ–°æ—¥å¿—å†…å®¹ï¼Œä½¿ç”¨é»˜è®¤æ¶ˆæ¯
          if [ -z "$changelog" ]; then
            changelog="## ğŸ“‹ æ›´æ–°æ—¥å¿—\n\n- $commit_msg ($commit_short)\n\n"
          fi
          
          changelog="$changelog---\n\n**æäº¤ä¿¡æ¯**: $commit_msg ($commit_short)\n**æäº¤è€…**: $commit_author"
          
          if ! git rev-parse "$tag_name" >/dev/null 2>&1; then
            echo "ğŸ€ğŸ€ æ–½åŠ æ–°çš„é­”æ³•å°è®°..."
            git tag "$tag_name"
            git push origin "$tag_name"
          fi

          # åˆ›å»ºæˆ–æ›´æ–°å‘è¡Œ
          if gh release view "$tag_name" &>/dev/null; then
            # å‘è¡Œå·²å­˜åœ¨ï¼Œæ›´æ–°å®ƒ
            gh release edit "$tag_name" \
              --notes "$changelog" \
              --title "âœ¨ è‰¾è‰ä¸çš„é­”æ³•æ›´æ–° $tag_name" \
              --prerelease=$is_dev
            echo "ğŸŒŸ å·²æ›´æ–°é­”æ³•ç‰ˆæœ¬ $tag_name"
          else
            # åˆ›å»ºæ–°å‘è¡Œ
            gh release create "$tag_name" \
              --notes "$changelog" \
              --title "âœ¨ è‰¾è‰ä¸çš„é­”æ³•æ›´æ–° $tag_name" \
              --prerelease=$is_dev
            echo "âœ¨ å·²å‘å¸ƒæ–°çš„é­”æ³•ç‰ˆæœ¬ $tag_name"
          fi
          
          # æ£€æŸ¥å¹¶æ›´æ–°æœ€è¿‘å‡ ä¸ªç‰ˆæœ¬çš„å‘è¡Œä¿¡æ¯
          echo "ğŸ” æ£€æŸ¥å¹¶æ›´æ–°æœ€è¿‘å‡ ä¸ªç‰ˆæœ¬çš„å‘è¡Œä¿¡æ¯..."
          
          # è·å–æœ€è¿‘çš„5ä¸ªæ ‡ç­¾ï¼ˆæ’é™¤å½“å‰æ ‡ç­¾ï¼‰
          recent_tags=$(git tag --sort=-version:refname | grep '^v[0-9]' | grep -v "^$tag_name$" | head -5)
          
          # åˆ›å»ºæ£€æŸ¥å’Œæ›´æ–°çš„è„šæœ¬
          cat > check_releases.py << 'EOF'
          import re
          import subprocess
          import os

          def get_changelog_for_version(version):
              """ä»CHANGELOG.mdä¸­è·å–æŒ‡å®šç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—"""
              changelog_path = 'CHANGELOG.md'
              
              if not os.path.exists(changelog_path):
                  return None
                  
              with open(changelog_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # å°è¯•ç²¾ç¡®åŒ¹é…ç‰ˆæœ¬å·
              pattern = rf'## \[{re.escape(version)}\].*?(?=## \[|$)'
              match = re.search(pattern, content, re.DOTALL)
              
              if match:
                  # æå–ç‰ˆæœ¬æ ‡é¢˜ä¸‹çš„å†…å®¹
                  changelog_section = match.group(0)
                  # ç§»é™¤å¼€å¤´çš„æ ‡é¢˜è¡Œ
                  changelog_lines = changelog_section.split('\n')[1:]
                  # å»é™¤ç©ºè¡Œ
                  changelog_content = '\n'.join(line for line in changelog_lines if line.strip())
                  return changelog_content
              
              return None

          def format_changelog(changelog):
              """æ ¼å¼åŒ–æ›´æ–°æ—¥å¿—ä¸ºGitHubå‹å¥½çš„æ ¼å¼"""
              if not changelog:
                  return "æ— æ›´æ–°æ—¥å¿—ä¿¡æ¯ã€‚"
                  
              # å¤„ç†åˆ—è¡¨é¡¹ï¼Œç¡®ä¿åœ¨Markdownä¸­æ­£ç¡®æ˜¾ç¤º
              lines = changelog.split('\n')
              formatted_lines = []
              
              for line in lines:
                  # ä¿ç•™åŸæœ‰çš„ç¼©è¿›æ ¼å¼ï¼Œç¡®ä¿åˆ—è¡¨é¡¹æ­£ç¡®æ˜¾ç¤º
                  if line.strip().startswith('-'):
                      formatted_lines.append(line)
                  elif line.strip() and not line.startswith('#'):
                      # æ™®é€šæ–‡æœ¬è¡Œï¼Œç¡®ä¿ä¸ä¸¢å¤±å†…å®¹
                      formatted_lines.append(line)
                  elif line.startswith('#'):
                      # æ ‡é¢˜è¡Œï¼Œè·³è¿‡ï¼ˆå› ä¸ºæˆ‘ä»¬å·²ç»åœ¨å‘å¸ƒè¯´æ˜ä¸­æœ‰ä¸€ä¸ªæ ‡é¢˜ï¼‰
                      continue
                  else:
                      # ç©ºè¡Œæˆ–å…¶ä»–è¡Œ
                      formatted_lines.append(line)
              
              return '\n'.join(formatted_lines)

          def update_github_release(tag, changelog):
              """æ›´æ–°GitHubå‘è¡Œä¿¡æ¯"""
              try:
                  # è·å–å½“å‰å‘è¡Œä¿¡æ¯
                  result = subprocess.run(
                      ['gh', 'release', 'view', tag, '--json', 'body', '--json', 'prerelease'],
                      capture_output=True, text=True, check=True
                  )
                  release_info = result.stdout
                  
                  # æ£€æŸ¥æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆ
                  is_prerelease = '"prerelease": true' in release_info
                  
                  # è·å–å½“å‰å‘è¡Œè¯´æ˜
                  body_match = re.search(r'"body":\s*"([^"]*)"', release_info)
                  if not body_match:
                      print(f"âŒ æ— æ³•è·å– {tag} çš„å‘è¡Œè¯´æ˜")
                      return False
                  
                  current_body = body_match.group(1).replace('\\n', '\n')
                  
                  # æ£€æŸ¥æ˜¯å¦å·²ç»åŒ…å«æ ¼å¼åŒ–çš„æ›´æ–°æ—¥å¿—
                  if "ğŸ“‹ æ›´æ–°æ—¥å¿—" in current_body and "### " in current_body:
                      print(f"âœ… å‘è¡Œ {tag} å·²åŒ…å«æ ¼å¼åŒ–çš„æ›´æ–°æ—¥å¿—ï¼Œè·³è¿‡")
                      return True
                  
                  # æ ¼å¼åŒ–æ›´æ–°æ—¥å¿—
                  formatted_changelog = format_changelog(changelog)
                  
                  # åˆ›å»ºæ–°çš„å‘è¡Œè¯´æ˜
                  new_notes = f"## ğŸ“‹ æ›´æ–°æ—¥å¿—\n\n{formatted_changelog}"
                  
                  # æ›´æ–°å‘è¡Œä¿¡æ¯
                  subprocess.run(
                      ['gh', 'release', 'edit', tag, '--notes', new_notes, f'--prerelease={is_prerelease}'],
                      capture_output=True, text=True, check=True
                  )
                  
                  print(f"âœ… å·²æ›´æ–°å‘è¡Œ {tag}")
                  return True
              except subprocess.CalledProcessError as e:
                  print(f"âŒ æ›´æ–°å‘è¡Œ {tag} å¤±è´¥: {e}")
                  return False

          # è·å–æ ‡ç­¾åˆ—è¡¨
          tags = """$recent_tags""".split('\n')
          tags = [tag.strip() for tag in tags if tag.strip()]
          
          updated_count = 0
          total_count = len(tags)
          
          print(f"æ£€æŸ¥ {total_count} ä¸ªæœ€è¿‘çš„å‘è¡Œ...")
          
          for tag in tags:
              if not tag:
                  continue
                  
              # ä»æ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å·
              version = tag.replace('v', '')
              print(f"\nå¤„ç†æ ‡ç­¾: {tag} (ç‰ˆæœ¬: {version})")
              
              changelog = get_changelog_for_version(version)
              
              if changelog:
                  if update_github_release(tag, changelog):
                      updated_count += 1
              else:
                  print(f"âš ï¸ æœªæ‰¾åˆ°ç‰ˆæœ¬ {version} çš„æ›´æ–°æ—¥å¿—")

          print(f"\nğŸ‰ æ£€æŸ¥å®Œæˆ! å·²æ›´æ–° {updated_count}/{total_count} ä¸ªå‘è¡Œã€‚")
          EOF
          
          # æ‰§è¡Œæ£€æŸ¥è„šæœ¬
          python check_releases.py
          
          # æ˜¾ç¤ºæœ€ç»ˆç»“æœ
          echo "ğŸ“¦ å‘è¡Œé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/$tag_name"
          
