name: ğŸ€ è‰¾è‰ä¸çš„ç‰ˆæœ¬æ ‡ç­¾é­”æ³• ~

# è‰¾è‰ä¸ä¼šè‡ªåŠ¨ä¸ºä¸»åˆ†æ”¯çš„æ›´æ–°æ‰“ä¸Šæ ‡ç­¾å–”!
permissions:
  contents: write

on:
  push:
    branches: [ main ]

jobs:
  auto-tag-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è¯»å–é­”æ³•å·è½´
        id: info
        shell: bash
        run: |
          # è§£è¯»ç‰ˆæœ¬é­”æ³•
          version=$(grep '^version' pyproject.toml | head -1 | sed 's/version = "//;s/"//')
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "âœ¨ å‘ç°æ–°ç‰ˆæœ¬: $version"
          
          # æ£€æŸ¥æ˜¯å¦æ˜¯è¯•éªŒé­”æ³•
          if [[ $version =~ dev|alpha|beta|a|b ]]; then
            echo "is_dev=true" >> $GITHUB_OUTPUT
          else
            echo "is_dev=false" >> $GITHUB_OUTPUT
          fi
          
          # è·å–é­”æ³•å˜æ›´è®°å½•
          commit_msg=$(git log -1 --pretty=%B)
          commit_short=$(git rev-parse --short HEAD)
          echo "commit_short=$commit_short" >> $GITHUB_OUTPUT
          echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "$commit_msg" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: æ–½å±•ç‰ˆæœ¬é­”æ³•
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          version="${{ steps.info.outputs.version }}"
          commit_short="${{ steps.info.outputs.commit_short }}"
          commit_msg="${{ steps.info.outputs.commit_msg }}"
          is_dev="${{ steps.info.outputs.is_dev }}"
          tag_name="v$version"
          
          # è¯»å–é­”æ³•è®°å½•ä¹¦
          if [ -f "docs/CHANGELOG.md" ]; then
            changelog=$(sed -n "/^## \[$version\]/,/^## /p" docs/CHANGELOG.md | sed '1d;$d')
          fi
          
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°è®°å½•,å°±ç”¨ç®€å•çš„é­”æ³•
          if [ -z "$changelog" ]; then
            changelog="### âœ¨ é­”æ³•æ›´æ–°\n\n- $commit_msg ($commit_short)"
          fi
          
          # æ£€æŸ¥é­”æ³•å°è®°æ˜¯å¦å·²å­˜åœ¨
          if ! git rev-parse "$tag_name" >/dev/null 2>&1; then
            echo "ğŸ€ æ–½åŠ æ–°çš„é­”æ³•å°è®°..."
            git tag "$tag_name"
            git push origin "$tag_name"
          fi
          
          # åœ¨é­”æ³•é›†å¸‚ä¸Šå‘å¸ƒ
          if gh release view "$tag_name" &>/dev/null; then
            # æ›´æ–°å·²æœ‰çš„é­”æ³•
            gh release edit "$tag_name" \
              --notes "$changelog" \
              --prerelease=$is_dev
            echo "ğŸŒŸ å·²æ›´æ–°é­”æ³•ç‰ˆæœ¬ $tag_name"
          else
            # å‘å¸ƒæ–°çš„é­”æ³•
            gh release create "$tag_name" \
              --notes "$changelog" \
              --title "âœ¨ è‰¾è‰ä¸çš„é­”æ³•æ›´æ–° $tag_name" \
              --prerelease=$is_dev
            echo "âœ¨ å·²å‘å¸ƒæ–°çš„é­”æ³•ç‰ˆæœ¬ $tag_name"
          fi