name: ğŸ€ è‰¾è‰ä¸çš„ç‰ˆæœ¬æ ‡ç­¾é­”æ³• ~

permissions:
  contents: write

on:
  push:
    branches: [main, Pre-Release/v2]

jobs:
  update-all-releases:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: æ–½å±•ç‰ˆæœ¬é­”æ³•
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          # åˆ›å»ºæ›´æ–°æ‰€æœ‰å‘è¡Œçš„è„šæœ¬
          cat > update_all_releases.py << 'EOF'
          import re
          import subprocess
          import os
          import sys

          def get_all_tags():
              """è·å–æ‰€æœ‰ç‰ˆæœ¬æ ‡ç­¾"""
              try:
                  result = subprocess.run(
                      ['git', 'tag', '--sort=-version:refname'],
                      capture_output=True, text=True, check=True
                  )
                  tags = [tag.strip() for tag in result.stdout.split('\n') if tag.strip() and tag.startswith('v')]
                  return tags
              except subprocess.CalledProcessError as e:
                  print(f"è·å–æ ‡ç­¾å¤±è´¥: {e}")
                  return []

          def get_changelog_for_version(version):
              changelog_path = 'CHANGELOG.md'
              
              if not os.path.exists(changelog_path):
                  return None
                  
              with open(changelog_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # å°è¯•ç²¾ç¡®åŒ¹é…ç‰ˆæœ¬å·
              pattern = rf'## \[{re.escape(version)}\].*?(?=## \[|$)'
              match = re.search(pattern, content, re.DOTALL)
              
              if match:
                  # æå–ç‰ˆæœ¬æ ‡é¢˜ä¸‹çš„å†…å®¹
                  changelog_section = match.group(0)
                  # ç§»é™¤å¼€å¤´çš„æ ‡é¢˜è¡Œ
                  changelog_lines = changelog_section.split('\n')[1:]
                  # å»é™¤ç©ºè¡Œ
                  changelog_content = '\n'.join(line for line in changelog_lines if line.strip())
                  return changelog_content
              
              return None

          def get_release_info(tag):
              """è·å–å‘è¡Œä¿¡æ¯"""
              try:
                  result = subprocess.run(
                      ['gh', 'release', 'view', tag, '--json', 'prerelease'],
                      capture_output=True, text=True, check=True
                  )
                  is_prerelease = '"prerelease": true' in result.stdout
                  return is_prerelease
              except subprocess.CalledProcessError as e:
                  print(f"è·å–å‘è¡Œ {tag} ä¿¡æ¯å¤±è´¥: {e}")
                  return None

          def update_release(tag, changelog, is_prerelease):
              """æ›´æ–°å‘è¡Œä¿¡æ¯"""
              try:
                  # ç›´æ¥ä½¿ç”¨æ›´æ–°æ—¥å¿—å†…å®¹ï¼Œä¸æ·»åŠ ä»»ä½•é¢å¤–å†…å®¹
                  subprocess.run(
                      ['gh', 'release', 'edit', tag, '--notes', changelog, f'--prerelease={is_prerelease}'],
                      capture_output=True, text=True, check=True
                  )
                  print(f"å·²æ›´æ–°å‘è¡Œ {tag}")
                  return True
              except subprocess.CalledProcessError as e:
                  print(f"æ›´æ–°å‘è¡Œ {tag} å¤±è´¥: {e}")
                  return False

          def main():
              # è·å–æ‰€æœ‰æ ‡ç­¾
              tags = get_all_tags()
              
              if not tags:
                  print("æœªæ‰¾åˆ°ä»»ä½•æ ‡ç­¾")
                  return
              
              print(f"æ‰¾åˆ° {len(tags)} ä¸ªæ ‡ç­¾ï¼Œå¼€å§‹æ›´æ–°...")
              
              updated_count = 0
              skipped_count = 0
              
              for tag in tags:
                  if not tag:
                      continue
                  
                  # ä»æ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å·
                  version = tag.replace('v', '')
                  print(f"\nå¤„ç†æ ‡ç­¾: {tag} (ç‰ˆæœ¬: {version})")
                  
                  # è·å–æ›´æ–°æ—¥å¿—
                  changelog = get_changelog_for_version(version)
                  
                  if not changelog:
                      print(f"âš ï¸ æœªæ‰¾åˆ°ç‰ˆæœ¬ {version} çš„æ›´æ–°æ—¥å¿—ï¼Œè·³è¿‡")
                      skipped_count += 1
                      continue
                  
                  # è·å–å‘è¡Œä¿¡æ¯
                  is_prerelease = get_release_info(tag)
                  
                  if is_prerelease is None:
                      print(f"âš ï¸ æ— æ³•è·å–å‘è¡Œ {tag} ä¿¡æ¯ï¼Œè·³è¿‡")
                      skipped_count += 1
                      continue
                  
                  # æ›´æ–°å‘è¡Œ
                  if update_release(tag, changelog, is_prerelease):
                      updated_count += 1
              
              print(f"\nğŸ‰ å®Œæˆ! æ›´æ–°äº† {updated_count} ä¸ªå‘è¡Œï¼Œè·³è¿‡äº† {skipped_count} ä¸ªå‘è¡Œã€‚")

          if __name__ == "__main__":
              main()
          EOF
          
          # æ‰§è¡Œè„šæœ¬
          python update_all_releases.py
          
          # å¦‚æœéœ€è¦åˆ›å»ºæ–°æ ‡ç­¾ï¼Œå¯ä»¥ä» pyproject.toml è¯»å–ç‰ˆæœ¬å¹¶åˆ›å»º
          if [ -f "pyproject.toml" ]; then
            version=$(grep '^version' pyproject.toml | head -1 | sed 's/version = "//;s/"//')
            tag_name="v$version"
            
            # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
            if ! git rev-parse "$tag_name" >/dev/null 2>&1; then
              echo "ğŸ€ğŸ€ åˆ›å»ºæ–°æ ‡ç­¾ $tag_name..."
              git tag "$tag_name"
              git push origin "$tag_name"
              
              # è·å–æ›´æ–°æ—¥å¿—å¹¶åˆ›å»ºå‘è¡Œ
              if [ -f "CHANGELOG.md" ]; then
                changelog_section=$(sed -n "/^## \[$version\]/,/^## /p" CHANGELOG.md | sed '1d;$d')
                if [ -n "$changelog_section" ]; then
                  # åˆ¤æ–­æ˜¯å¦ä¸ºå¼€å‘ç‰ˆæœ¬
                  if [[ $version =~ dev|alpha|beta|a|b ]]; then
                    is_dev="true"
                  else
                    is_dev="false"
                  fi
                  
                  # åˆ›å»ºæ–°å‘è¡Œ
                  gh release create "$tag_name" \
                    --notes "$changelog_section" \
                    --title "âœ¨ è‰¾è‰ä¸çš„é­”æ³•æ›´æ–° $tag_name" \
                    --prerelease=$is_dev
                  echo "âœ¨ å·²åˆ›å»ºæ–°çš„é­”æ³•ç‰ˆæœ¬ $tag_name"
                fi
              fi
            else
              echo "æ ‡ç­¾ $tag_name å·²å­˜åœ¨"
            fi
          fi
