name: ğŸ€ è‰¾è‰ä¸çš„é­”æ³•é‚®å·®æœåŠ¡ ~

on:
  workflow_call:
    inputs:
      subject:
        type: string
        default: "[è‰¾è‰ä¸æ¥ä¿¡] æ‚¨æœ‰ä¸€å°æ–°é€šçŸ¥~ âœ¨"
      content:
        type: string
        required: true

jobs:
  send-mail:
    runs-on: ubuntu-latest
    name: ğŸ“¨ è‰¾è‰ä¸é€ä¿¡å»å•¦!

    steps:
      - name: ğŸ§¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“– è¯»å–æ”¶ä»¶äººåˆ—è¡¨
        id: read_emails
        run: |
          emails=$(cat .github/config/notify_emails.json | jq -r '.emails[]')
          echo "emails=$emails" >> $GITHUB_OUTPUT

      - name: ğŸ å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install smtplib email

      - name: ğŸ’Œ å‡†å¤‡å¹¶å‘é€é‚®ä»¶
        env:
          MAIL_USER: ${{ secrets.MAIL_USER }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          SUBJECT: ${{ inputs.subject }}
          CONTENT: ${{ inputs.content }}
        run: |
          IFS=$'\n'
          emails=($(echo "$INPUT_EMAILS"))

          cat << EOF > send_mail.py
          import smtplib
          from email.message import EmailMessage
          import os

          recipients = [
            ${emails[@]/#/$'"'}${emails[@]/%/$'"'}
          ]

          msg = EmailMessage()
          msg['Subject'] = os.getenv("SUBJECT")
          msg['From'] = os.getenv("MAIL_USER")
          msg['To'] = ", ".join(recipients)
          msg.set_content(os.getenv("CONTENT"))

          with smtplib.SMTP("mail.anran.xyz", 587) as server:
              server.starttls()
              server.login(os.getenv("MAIL_USER"), os.getenv("MAIL_PASSWORD"))
              server.send_message(msg)

          print("ğŸ’Œ é­”æ³•ä¿¡ä»¶å·²æˆåŠŸå¯„å‡ºï¼")
          EOF

          python send_mail.py
        env:
          INPUT_EMAILS: ${{ steps.read_emails.outputs.emails }}