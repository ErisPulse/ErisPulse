name: ğŸ”® è‰¾è‰ä¸çš„ç±»å‹å­˜æ ¹å·¥åŠ ~

permissions:
  contents: write

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:

jobs:
  update-type-stubs:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºé­”æ³•ä¹¦
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: å‡†å¤‡é­”æ³•ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: å­¦ä¹ é­”æ³•å’’è¯­
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: ğŸ”® ç”Ÿæˆç±»å‹å­˜æ ¹
        id: generate-stubs
        run: |
          echo "ğŸ”® è‰¾è‰ä¸å¼€å§‹ç”Ÿæˆç±»å‹å­˜æ ¹äº†å“¦~"
          
          # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
          mkdir -p src
          
          # è¿è¡Œç±»å‹å­˜æ ¹ç”Ÿæˆè„šæœ¬
          if [ -f ".github/tools/generate-type-stubs.py" ]; then
            python .github/tools/generate-type-stubs.py --src src --output stubs --clean --force
            echo "âœ… ç±»å‹å­˜æ ¹ç”Ÿæˆå®Œæˆ!"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ç±»å‹å­˜æ ¹ç”Ÿæˆè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
            exit 1
          fi
          
          # æ£€æŸ¥ç±»å‹å­˜æ ¹æ˜¯å¦æœ‰æ›´æ–°
          if git diff --quiet stubs/; then
            echo "ç±»å‹å­˜æ ¹æ²¡æœ‰å˜åŒ–"
            echo "stubs_updated=false" >> $GITHUB_OUTPUT
          else
            echo "å‘ç°äº†ç±»å‹å­˜æ ¹æ›´æ–°!"
            echo "stubs_updated=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š ç»Ÿè®¡æ›´æ–°æƒ…å†µ
        run: |
          echo "ğŸ“ˆ è‰¾è‰ä¸æ­£åœ¨ç»Ÿè®¡ä»Šå¤©çš„ç±»å‹å­˜æ ¹æ›´æ–°æƒ…å†µ~"
          
          # ç»Ÿè®¡æ–°å¢çš„.pyiæ–‡ä»¶
          new_pyi=$(git diff --name-only --diff-filter=A stubs/ 2>/dev/null | grep "\.pyi$" | wc -l)
          echo "ğŸ†• æ–°å¢.pyiæ–‡ä»¶æ•°: $new_pyi"
          
          # ç»Ÿè®¡ä¿®æ”¹çš„.pyiæ–‡ä»¶
          modified_pyi=$(git diff --name-only --diff-filter=M stubs/ 2>/dev/null | grep "\.pyi$" | wc -l)
          echo "ğŸ“ ä¿®æ”¹.pyiæ–‡ä»¶æ•°: $modified_pyi"
          
          # ç»Ÿè®¡åˆ é™¤çš„.pyiæ–‡ä»¶
          deleted_pyi=$(git diff --name-only --diff-filter=D stubs/ 2>/dev/null | grep "\.pyi$" | wc -l)
          echo "ğŸ—‘ï¸ åˆ é™¤.pyiæ–‡ä»¶æ•°: $deleted_pyi"
          
          # åˆ—å‡ºæ‰€æœ‰å˜åŒ–çš„.pyiæ–‡ä»¶
          echo ""
          echo "ğŸ“‹ å˜åŒ–çš„ç±»å‹å­˜æ ¹æ–‡ä»¶åˆ—è¡¨:"
          git diff --name-only stubs/ 2>/dev/null | grep "\.pyi$" | head -20 || echo "  (æ— )"

      - name: ğŸ’¾ æäº¤æ›´æ–°
        if: steps.generate-stubs.outputs.stubs_updated == 'true'
        run: |
          echo "ğŸ’¾ è‰¾è‰ä¸æ­£åœ¨ä¿å­˜ç±»å‹å­˜æ ¹æ›´æ–°~"
          
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config --local user.email "eris@magic-circle.dev"
          git config --local user.name "Eris the Type Sorceress"
          
          # æ·»åŠ æ‰€æœ‰.pyiæ–‡ä»¶
          git add stubs/**/*.pyi
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          commit_msg="ğŸ”® è‰¾è‰ä¸çš„è‡ªåŠ¨ç±»å‹å­˜æ ¹æ›´æ–°é­”æ³• [skip ci]
          
          ğŸ“ è‡ªåŠ¨æ›´æ–°äº†é¡¹ç›®ç±»å‹å­˜æ ¹æ–‡ä»¶
          ğŸ”® ä¸ºæ‰€æœ‰Pythonæ¨¡å—ç”Ÿæˆäº†.pyiç±»å‹æ³¨è§£æ–‡ä»¶
          ğŸ“š æ”¯æŒIDEçš„ç±»å‹æç¤ºå’Œè‡ªåŠ¨è¡¥å…¨
          
          ğŸŒŸ è¯¦æƒ…è¯·æŸ¥çœ‹ stubs/ ç›®å½•ä¸‹çš„.pyiæ–‡ä»¶"
          
          # æäº¤æ›´æ”¹
          git commit -m "$commit_msg"
          git push

      - name: ğŸ‰ ç±»å‹å­˜æ ¹æ›´æ–°å®Œæˆ
        if: steps.generate-stubs.outputs.stubs_updated == 'true'
        run: |
          echo "ğŸŒŸ è‰¾è‰ä¸ä»Šå¤©ä¹ŸåŠªåŠ›å®Œæˆäº†ç±»å‹å­˜æ ¹æ›´æ–°çš„é­”æ³•å‘¢!"
          echo "ğŸ“š æ‰€æœ‰ç±»å‹å­˜æ ¹æ–‡ä»¶å·²æ›´æ–°å¹¶æäº¤åˆ°ä»“åº“"
          echo "ğŸ’« åŒ…å«äº†æœ€æ–°çš„ç±»å‹æ³¨è§£ä¿¡æ¯"
          echo "ğŸŒ™ ä»Šå¤©çš„ç±»å‹ç‚¼é‡‘å·¥ä½œå®Œæˆå•¦~"

      - name: ğŸ˜Š æ— æ›´æ–°æ—¶çš„è¯´æ˜
        if: steps.generate-stubs.outputs.stubs_updated != 'true'
        run: |
          echo "âœ¨ ä»Šå¤©æ²¡æœ‰å‘ç°éœ€è¦æ›´æ–°çš„ç±»å‹å­˜æ ¹å‘¢~"
          echo "ğŸ“š æ‰€æœ‰ç±»å‹å­˜æ ¹éƒ½æ˜¯æœ€æ–°çŠ¶æ€"
          echo "ğŸŒŸ è‰¾è‰ä¸ä¼šç»§ç»­å®ˆæŠ¤ç€æˆ‘ä»¬çš„ç±»å‹åº“!"
          echo "ğŸŒ™ ä¸‹æ¬¡æ›´æ–°å†è§å•¦~"
