name: ğŸ”§ è‰¾è‰ä¸çš„ç±»å‹ç‚¼é‡‘å·¥æˆ¿ ~

permissions:
  contents: write

on:
  push:
    branches: [main, Pre-Release/v2, Develop/v2]
  pull_request:
    branches: [main, Pre-Release/v2, Develop/v2]
  workflow_dispatch:

jobs:
  update-and-generate-stubs:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºé­”æ³•ä¹¦
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: å‡†å¤‡é­”æ³•ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ğŸ”® ç”Ÿæˆç±»å‹å­˜æ ¹
        id: generate-stubs
        run: |
          echo "ğŸ”® è‰¾è‰ä¸å¼€å§‹æ–½å±•ç±»å‹å­˜æ ¹ç”Ÿæˆé­”æ³•~"
          
          # è¿è¡Œç±»å‹å­˜æ ¹ç”Ÿæˆè„šæœ¬
          if [ -f ".github/tools/generate-type-stubs.py" ]; then
            python .github/tools/generate-type-stubs.py --src src --output stubs --clean
            echo "âœ… ç±»å‹å­˜æ ¹ç”Ÿæˆå®Œæˆ!"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ç±»å‹å­˜æ ¹ç”Ÿæˆè„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
            exit 1
          fi
          
          # æ£€æŸ¥ç±»å‹å­˜æ ¹æ˜¯å¦æœ‰æ›´æ–°
          if git diff --quiet stubs/; then
            echo "ç±»å‹å­˜æ ¹æ²¡æœ‰å˜åŒ–"
            echo "stubs_updated=false" >> $GITHUB_OUTPUT
          else
            echo "å‘ç°äº†ç±»å‹å­˜æ ¹æ›´æ–°!"
            echo "stubs_updated=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š ç»Ÿè®¡æ›´æ–°æƒ…å†µ
        if: steps.generate-stubs.outputs.stubs_updated == 'true'
        run: |
          echo "ğŸ“ˆ è‰¾è‰ä¸æ­£åœ¨ç»Ÿè®¡ä»Šå¤©çš„ç±»å‹å­˜æ ¹æ›´æ–°æƒ…å†µ~"
          
          # ç»Ÿè®¡æ›´æ–°çš„æ–‡ä»¶æ•°
          updated_files=$(git diff --name-only stubs/ 2>/dev/null | grep "\.pyi$" | wc -l)
          echo "ğŸ“¦ ç±»å‹å­˜æ ¹æ›´æ–°æ–‡ä»¶æ•°: $updated_files"
          
          # åˆ—å‡ºæ›´æ–°çš„æ–‡ä»¶
          echo ""
          echo "ğŸ“ æ›´æ–°çš„æ–‡ä»¶åˆ—è¡¨:"
          git diff --name-only stubs/ 2>/dev/null | grep "\.pyi$" | while read file; do
            echo "  - $file"
          done

      - name: ğŸ’¾ æäº¤æ›´æ–°
        if: steps.generate-stubs.outputs.stubs_updated == 'true'
        run: |
          echo "ğŸ’¾ è‰¾è‰ä¸æ­£åœ¨ä¿å­˜ç±»å‹å­˜æ ¹æ›´æ–°~"
          
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config --local user.email "eris@magic-circle.dev"
          git config --local user.name "Eris the Scribe"
          
          # æ·»åŠ æ‰€æœ‰æ›´æ–°çš„ç±»å‹å­˜æ ¹æ–‡ä»¶
          git add stubs/
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          commit_msg="ğŸ”§ è‰¾è‰ä¸çš„è‡ªåŠ¨ç±»å‹å­˜æ ¹æ›´æ–°é­”æ³• [skip ci]
          
          ğŸ“¦ è‡ªåŠ¨æ›´æ–°äº†ç±»å‹å­˜æ ¹æ–‡ä»¶
          ğŸ¯ ä»æºä»£ç ç”Ÿæˆæœ€æ–°çš„ .pyi æ–‡ä»¶
          ğŸ’¡ IDE å°†è·å¾—å®Œæ•´çš„ç±»å‹æç¤ºå’Œè‡ªåŠ¨è¡¥å…¨
          
          ğŸŒŸ è¯¦æƒ…è¯·æŸ¥çœ‹ stubs/ ç›®å½•"
          
          # æäº¤æ›´æ”¹
          git commit -m "$commit_msg"
          git push

      - name: ğŸ‰ ç±»å‹å­˜æ ¹æ›´æ–°å®Œæˆ
        if: steps.generate-stubs.outputs.stubs_updated == 'true'
        run: |
          echo "ğŸŒŸ è‰¾è‰ä¸ä»Šå¤©ä¹ŸåŠªåŠ›å®Œæˆäº†ç±»å‹å­˜æ ¹æ›´æ–°çš„é­”æ³•å‘¢!"
          echo "ğŸ“¦ æ‰€æœ‰ç±»å‹å­˜æ ¹å·²æ›´æ–°å¹¶æäº¤åˆ°ä»“åº“"
          echo "ğŸ’« IDE ç°åœ¨å¯ä»¥è·å¾—å®Œæ•´çš„ç±»å‹æç¤ºäº†"
          echo "ğŸŒ™ ä»Šå¤©çš„ç±»å‹ç‚¼é‡‘å·¥ä½œå®Œæˆå•¦~"

      - name: ğŸ˜Š æ— æ›´æ–°æ—¶çš„è¯´æ˜
        if: steps.generate-stubs.outputs.stubs_updated != 'true'
        run: |
          echo "âœ¨ ä»Šå¤©æ²¡æœ‰å‘ç°éœ€è¦æ›´æ–°çš„ç±»å‹å­˜æ ¹å‘¢~"
          echo "ğŸ“¦ æ‰€æœ‰ç±»å‹å­˜æ ¹éƒ½æ˜¯æœ€æ–°çŠ¶æ€"
          echo "ğŸŒŸ è‰¾è‰ä¸ä¼šç»§ç»­å®ˆæŠ¤ç€æˆ‘ä»¬çš„ç±»å‹æç¤º!"
          echo "ğŸŒ™ ä¸‹æ¬¡æ›´æ–°å†è§å•¦~"
