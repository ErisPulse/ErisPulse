name: 🎀 艾莉丝的API文档魔法 ~

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'ErisPulse/*.py'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-docs:
    name: ✨ 更新API文档
    runs-on: ubuntu-latest
    
    steps:
      - name: 🏗️ 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 🐍 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: 📦 安装依赖
        run: |
          python -m pip install --upgrade pip
          
      - name: 📝 更新API文档
        run: |
          python ${{ github.action_path }}/update_api_docs.py
          
      - name: 📚 获取变更信息
        id: changes
        run: |
          changed=$(git status --porcelain docs/REFERENCE.md)
          if [ -n "$changed" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
          
      - name: 💾 提交变更
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name "docs-update[bot]"
          git config --global user.email "114514@erisdev.com"
          git add docs/REFERENCE.md
          git commit -m "📝 [自动更新] API文档"
          git push

      - name: 📩 发送通知
        if: steps.changes.outputs.has_changes == 'true'
        uses: ./.github/workflows/send-email
        with:
          subject: "[艾莉丝快报] API文档已更新"
          content: |
            <div style="font-family: 'Segoe UI', sans-serif; background-color: #2a2a3c; color: #f5f5f5; padding: 20px; border-radius: 8px;">
              <table width="100%" cellpadding="0" cellspacing="0">
                <tr>
                  <td align="center">
                    <img src="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/assets/erispulse_logo.png" alt="ErisPulse Logo"/>
                  </td>
                </tr>
              </table>

              <h2 style="color: #ff6ec7;">API文档已被魔法更新 ✨</h2>

              <hr style="border: none; border-top: 1px solid #333; margin: 20px 0;" />

              <p><strong>更新内容：</strong></p>
              <pre style="background-color: #3b3b4f; padding: 10px; border-radius: 4px; white-space: pre-wrap;">$(git diff --cached docs/REFERENCE.md)</pre>

              <p><strong>查看完整文档：</strong><br/>
              <a href="https://github.com/${{ github.repository }}/blob/main/docs/REFERENCE.md" style="color: #7acbf7; text-decoration: none;">
                点击查看API文档
              </a></p>

              <p>—— 艾莉丝·格雷拉特 ⚔️</p>
            </div>
          recipients: ${{ toJson(fromJson('{"emails":["dev@erisdev.com"]}').emails) }}
          resend_api_key: ${{ secrets.RESEND_API_KEY }}
          feishu_smtp_password: ${{ secrets.FEISHU_SMTP_PASSWORD }}