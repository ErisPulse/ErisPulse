name: ğŸ€ è‰¾è‰ä¸çš„APIæ–‡æ¡£é­”æ³• ~

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'ErisPulse/*.py'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-docs:
    name: âœ¨ æ›´æ–°APIæ–‡æ¡£
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ—ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          
      - name: ğŸ“ æ›´æ–°APIæ–‡æ¡£
        run: |
          python ${{ github.action_path }}/update_api_docs.py
          
      - name: ğŸ“š è·å–å˜æ›´ä¿¡æ¯
        id: changes
        run: |
          changed=$(git status --porcelain docs/REFERENCE.md)
          if [ -n "$changed" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ’¾ æäº¤å˜æ›´
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name "docs-update[bot]"
          git config --global user.email "114514@erisdev.com"
          git add docs/REFERENCE.md
          git commit -m "ğŸ“ [è‡ªåŠ¨æ›´æ–°] APIæ–‡æ¡£"
          git push

      - name: ğŸ“© å‘é€é€šçŸ¥
        if: steps.changes.outputs.has_changes == 'true'
        uses: ./.github/workflows/send-email
        with:
          subject: "[è‰¾è‰ä¸å¿«æŠ¥] APIæ–‡æ¡£å·²æ›´æ–°"
          content: |
            <div style="font-family: 'Segoe UI', sans-serif; background-color: #2a2a3c; color: #f5f5f5; padding: 20px; border-radius: 8px;">
              <table width="100%" cellpadding="0" cellspacing="0">
                <tr>
                  <td align="center">
                    <img src="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/assets/erispulse_logo.png" alt="ErisPulse Logo"/>
                  </td>
                </tr>
              </table>

              <h2 style="color: #ff6ec7;">APIæ–‡æ¡£å·²è¢«é­”æ³•æ›´æ–° âœ¨</h2>

              <hr style="border: none; border-top: 1px solid #333; margin: 20px 0;" />

              <p><strong>æ›´æ–°å†…å®¹ï¼š</strong></p>
              <pre style="background-color: #3b3b4f; padding: 10px; border-radius: 4px; white-space: pre-wrap;">$(git diff --cached docs/REFERENCE.md)</pre>

              <p><strong>æŸ¥çœ‹å®Œæ•´æ–‡æ¡£ï¼š</strong><br/>
              <a href="https://github.com/${{ github.repository }}/blob/main/docs/REFERENCE.md" style="color: #7acbf7; text-decoration: none;">
                ç‚¹å‡»æŸ¥çœ‹APIæ–‡æ¡£
              </a></p>

              <p>â€”â€” è‰¾è‰ä¸Â·æ ¼é›·æ‹‰ç‰¹ âš”ï¸</p>
            </div>
          recipients: ${{ toJson(fromJson('{"emails":["dev@erisdev.com"]}').emails) }}
          resend_api_key: ${{ secrets.RESEND_API_KEY }}
          feishu_smtp_password: ${{ secrets.FEISHU_SMTP_PASSWORD }}