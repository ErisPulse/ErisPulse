name: ğŸ€ è‰¾è‰ä¸çš„é­”æ³•é‚®ä»¶æœåŠ¡ ~

on:
  workflow_call:
    inputs:
      subject:
        type: string
        default: "[è‰¾è‰ä¸å¿«æŠ¥] é»˜è®¤ä¸»é¢˜"
      content:
        type: string
        required: true
      recipients:
        type: json
        description: "æ”¶ä»¶äººåˆ—è¡¨"

jobs:
  send-email:
    runs-on: ubuntu-latest
    steps:

      - name: å‘é€é‚®ä»¶
        run: |
          cat << EOF > send_mail.py
          import requests
          import os
          import json

          # æ¥æ”¶ç¯å¢ƒå˜é‡
          recipients = json.loads(os.getenv("RECIPIENTS_JSON"))
          resend_api_key = os.getenv("RESEND_API_KEY")
          subject = os.getenv("SUBJECT")
          content = os.getenv("CONTENT")

          response = requests.post(
              "https://api.resend.com/emails",
              headers={
                  "Authorization": f"Bearer {resend_api_key}",
                  "Content-Type": "application/json"
              },
              json={
                  "from": "ErisPulse <noreply@anran.xyz>",
                  "to": recipients,
                  "subject": subject,
                  "text": content
              }
          )

          if response.status_code == 200:
              print("ğŸ’Œ é­”æ³•ä¿¡ä»¶å·²æˆåŠŸå¯„å‡ºï¼")
          else:
              print(f"âŒ å‘é€å¤±è´¥: {response.text}")
              exit(1)
          EOF

          python send_mail.py
        env:
          RECIPIENTS_JSON: ${{ toJson(inputs.recipients) }}
          SUBJECT: ${{ inputs.subject }}
          CONTENT: ${{ inputs.content }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}