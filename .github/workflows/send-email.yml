name: 🎀 艾莉丝的魔法邮件服务 ~

on:
  workflow_call:
    inputs:
      subject:
        type: string
        default: "[艾莉丝快报] 默认主题"
      content:
        type: string
        required: true
      recipients:
        type: json
        description: "收件人列表"

jobs:
  send-email:
    runs-on: ubuntu-latest
    steps:

      - name: 发送邮件
        run: |
          cat << EOF > send_mail.py
          import requests
          import os
          import json

          # 接收环境变量
          recipients = json.loads(os.getenv("RECIPIENTS_JSON"))
          resend_api_key = os.getenv("RESEND_API_KEY")
          subject = os.getenv("SUBJECT")
          content = os.getenv("CONTENT")

          response = requests.post(
              "https://api.resend.com/emails",
              headers={
                  "Authorization": f"Bearer {resend_api_key}",
                  "Content-Type": "application/json"
              },
              json={
                  "from": "ErisPulse <noreply@anran.xyz>",
                  "to": recipients,
                  "subject": subject,
                  "text": content
              }
          )

          if response.status_code == 200:
              print("💌 魔法信件已成功寄出！")
          else:
              print(f"❌ 发送失败: {response.text}")
              exit(1)
          EOF

          python send_mail.py
        env:
          RECIPIENTS_JSON: ${{ toJson(inputs.recipients) }}
          SUBJECT: ${{ inputs.subject }}
          CONTENT: ${{ inputs.content }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}